<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="images/favicon.ico">
        

	<title>Module 5 - Snapshot Operations and Administration - RHGS Test Drive Instructions</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">
        <link href="../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">RHGS Test Drive Instructions</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Introduction</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Modules <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../gluster-module-1/">Module 1 - Introduction to Gluster concepts</a>
</li>

                    
                        
<li >
    <a href="../gluster-module-2/">Module 2 - Volume Setup and Client Access</a>
</li>

                    
                        
<li >
    <a href="../gluster-module-3/">Module 3 - Volume Operations and Administration</a>
</li>

                    
                        
<li >
    <a href="../gluster-module-4/">Module 4 - Disperse Volumes (Erasure Coding)</a>
</li>

                    
                        
<li class="active">
    <a href="./">Module 5 - Snapshot Operations and Administration</a>
</li>

                    
                        
<li >
    <a href="../gluster-module-6/">Module 6 - Geo-Replication and Disaster Recovery</a>
</li>

                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li >
                    <a rel="next" href="../gluster-module-4/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../gluster-module-6/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#lab-guide-gluster-test-drive-module-5-snapshot-operations-and-administration">Lab Guide  Gluster Test Drive Module 5  Snapshot Operations and Administration</a></li>
        
            <li><a href="#lab-agenda">LAB AGENDA</a></li>
        
            <li><a href="#about-snapshots">ABOUT SNAPSHOTS</a></li>
        
            <li><a href="#getting-started">GETTING STARTED</a></li>
        
            <li><a href="#lab-setup">LAB SETUP</a></li>
        
            <li><a href="#snapshot-prerequisites">SNAPSHOT PREREQUISITES</a></li>
        
            <li><a href="#optional-create-the-distvol-volume">OPTIONAL: CREATE THE DISTVOL VOLUME</a></li>
        
            <li><a href="#nfs-client-access">NFS CLIENT ACCESS</a></li>
        
            <li><a href="#creation-of-snapshots">CREATION OF SNAPSHOTS</a></li>
        
            <li><a href="#retrieve-information-about-snapshots">RETRIEVE INFORMATION ABOUT SNAPSHOTS</a></li>
        
            <li><a href="#access-and-restore-snapshots">ACCESS AND RESTORE SNAPSHOTS</a></li>
        
            <li><a href="#configure-snapshot-behaviour">CONFIGURE SNAPSHOT BEHAVIOUR</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="lab-guide-gluster-test-drive-module-5-snapshot-operations-and-administration">Lab Guide <br/> Gluster Test Drive Module 5 <br/> Snapshot Operations and Administration</h1>
<h2 id="lab-agenda">LAB AGENDA</h2>
<p>Welcome to the Gluster Test Drive Module 5 - Snapshots</p>
<ul>
<li>Learn how snapshots are created and deleted</li>
<li>List available snapshot and get information about them</li>
<li>Access and restore snapshots</li>
<li>Configure snapshot behaviour</li>
</ul>
<h2 id="about-snapshots">ABOUT SNAPSHOTS</h2>
<p>Snapshots are <strong>point-in-time copies</strong> of volumes, which can be used to protect data. They are read-only by default so data on them can&rsquo;t be accidentally deleted, corrupted or modified. </p>
<p>The most important features of snapshots are:</p>
<ul>
<li>Crash consistency</li>
<li>Online snapshots</li>
<li>Quorum based</li>
</ul>
<p>Each snapshot creates as many bricks as the original volume has.</p>
<h2 id="getting-started">GETTING STARTED</h2>
<p>If you have not already done so, click the <img src="http://us-west-2-aws-training.s3.amazonaws.com/awsu-spl/spl02-working-ebs/media/image005.png"> button in the navigation bar above to launch your lab. If you are prompted for a token, use the one distributed to you (or credits you&rsquo;ve purchased).</p>
<blockquote>
<p><strong>NOTE</strong> It may take <strong>up to 10 minutes</strong> for your lab systems to start up before you can access them.</p>
</blockquote>
<h2 id="lab-setup">LAB SETUP</h2>
<h3 id="connect-to-the-lab">CONNECT TO THE LAB</h3>
<p>connect to the <strong>rhgs1</strong> server instance, using its public IP address from the<br />
<strong>Addl. Info</strong> tab to the right. </p>
<div class="codehilite"><pre><span></span>ssh student@&lt;rhgs1PublicIP&gt;
</pre></div>


<h2 id="snapshot-prerequisites">SNAPSHOT PREREQUISITES</h2>
<p>The snapshots will consists of the same number of bricks as the original<br />
volumes. By default bricks communicate via privileged ports, but the number of<br />
such ports is limited to 1024. In order to support up to 256 snapshots per<br />
volume the glusterd must be allowed to use non-privileged ports:</p>
<p>Permit insecure ports for the volume for which snapshots will be used:</p>
<div class="codehilite"><pre><span></span><span class="c1"># sudo gluster volume set repvol server.allow-insecure on</span>
</pre></div>


<p>Edit <code>/etc/glusterfs/glusterd.vol</code> in every cluster node, and add the<br />
following line:</p>
<div class="codehilite"><pre><span></span>option rpc-auth-allow-insecure on
</pre></div>


<p>Then restart the glusterd service to make make the changes effective:</p>
<div class="codehilite"><pre><span></span><span class="c1"># sudo systemctl restart glusterd</span>
</pre></div>


<h2 id="optional-create-the-distvol-volume">OPTIONAL: CREATE THE DISTVOL VOLUME</h2>
<p>If you have not already done so as part of <strong>Module 2</strong>, deploy the <code>distvol</code> volume, using the provided gdeploy configuration file.</p>
<div class="codehilite"><pre><span></span>gdeploy -c ~/materials/gdeploy/distvol.conf
</pre></div>


<p>Confirm the volume configuration.</p>
<div class="codehilite"><pre><span></span>sudo gluster volume info distvol
<span class="sb">``</span>
Volume Name: distvol
Type: Distribute
Volume ID: 957b4f60-4c2e-401f-b13c-558fd9df0c45
Status: Started
Snapshot Count: <span class="m">0</span>
Number of Bricks: <span class="m">6</span>
Transport-type: tcp
Bricks:
Brick1: rhgs1:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick1/distvol
Brick2: rhgs2:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick2/distvol
Brick3: rhgs3:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick3/distvol
Brick4: rhgs4:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick4/distvol
Brick5: rhgs5:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick5/distvol
Brick6: rhgs6:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick6/distvol
Options Reconfigured:
transport.address-family: inet
nfs.disable: off
features.quota: off
features.inode-quota: off
features.quota-deem-statfs: off
</pre></div>


<p>Make sure the <code>nfs.disable</code> attribute is set to off. In case it&rsquo;s not, run</p>
<div class="codehilite"><pre><span></span>sudo gluster volume <span class="nb">set</span> distvol nfs.disable off
</pre></div>


<h2 id="nfs-client-access">NFS CLIENT ACCESS</h2>
<p>A Gluster volume can be accessed through multiple standard client protocols, as well as through specialized methods including the OpenStack Swift protocol and a direct API.  </p>
<p>For many common use cases, the well-established NFS protocol is used for ease of implementation and compatibility with existing applications and architectures. For some use cases, the NFS protocol may also offer a performance benefit over other access methods. </p>
<p>You can connect to the <strong>client1</strong> system via <code>ssh</code> directly from the rhgs1 system.    </p>
<div class="codehilite"><pre><span></span>ssh student@client1                                                                    
</pre></div>


<p>Here, on the RHEL client, you will mount via NFS the Gluster <strong>distvol</strong> volume you created above.                                                                            </p>
<div class="codehilite"><pre><span></span>sudo mkdir -p /rhgs/client/nfs/distvol 
sudo mount -t nfs rhgs1:/distvol /rhgs/client/nfs/distvol 
</pre></div>


<p>Check the mount and observe the output.                                                </p>
<div class="codehilite"><pre><span></span>df -h /rhgs/client/nfs/distvol 
</pre></div>


<p><code>Filesystem      Size  Used Avail Use% Mounted on</code>                                 <br />
<code>rhgs1:/distvol   60G  198M   60G   1% /rhgs/client/nfs/distvol</code>                     </p>
<div class="codehilite"><pre><span></span>mount <span class="p">|</span> grep distvol                                                                   
</pre></div>


<p><code>rhgs1:/distvol on /rhgs/client/nfs/distvol type nfs (rw,relatime,vers=3,rsize=1048576,wsize=1048576,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=10.100.1.11,mountvers=3,mountport=38465,mountproto=tcp,local_lock=none,addr=10.100.1.11)</code>     </p>
<p>Create and set permissions on a subdirectory to hold your data.                        </p>
<div class="codehilite"><pre><span></span>sudo mkdir /rhgs/client/nfs/distvol/mydir                                              
sudo chmod <span class="m">777</span> /rhgs/client/nfs/distvol/mydir                                          
</pre></div>


<p>Add 100 files to the directory.                                                        </p>
<div class="codehilite"><pre><span></span><span class="k">for</span> i in <span class="o">{</span><span class="m">001</span>..100<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> hello<span class="nv">$i</span> &gt; /rhgs/client/nfs/distvol/mydir/file<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>     
</pre></div>


<p>List the directory, counting its contents to confirm the 100 files written.                                                                                                  </p>
<div class="codehilite"><pre><span></span>ls /rhgs/client/nfs/distvol/mydir/ <span class="p">|</span> wc -l                                                                                                                                   
</pre></div>


<p><code>100</code>                                                                                                                                                                      </p>
<h2 id="creation-of-snapshots">CREATION OF SNAPSHOTS</h2>
<p>Now that the volume is populated with your 100 data files take a snapshot on <strong>rhgs1</strong></p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot create snap1 distvol no-timestamp description <span class="s2">&quot;populated volume&quot;</span>
</pre></div>


<p><code>snapshot create: success: Snap snap1 created successfully</code></p>
<h2 id="retrieve-information-about-snapshots">RETRIEVE INFORMATION ABOUT SNAPSHOTS</h2>
<p>Check the list of available snapshots</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot list
</pre></div>


<p><code>snap1</code></p>
<p>There is more information available for this snapshot</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot info volume distvol
</pre></div>


<p><code>Volume Name               : distvol        
Snaps Taken               : 1              
Snaps Available           : 255            
        Snapshot                  : snap1                      
        Snap UUID                 : bc9abd1b-6239-49ec-aa0c-d0e56d619dd1               
        Description               : populated volume                                   
        Created                   : 2018-01-30 10:47:28                                
        Status                    : Stopped</code></p>
<h2 id="access-and-restore-snapshots">ACCESS AND RESTORE SNAPSHOTS</h2>
<p>Snaphosts of volumes can only be accessed via FUSE (native) mounts. <br />
In order to do that snapshots must be activated.</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot activate snap1
</pre></div>


<p><code>Snapshot activate: snap1: Snap activated successfully</code></p>
<p>Connect to <strong>client1</strong> using ssh and create a directory for the snapshots to be mounted:</p>
<div class="codehilite"><pre><span></span>sudo mkdir -p /rhgs/snaps/snap1
</pre></div>


<p>Mount the snapshot using</p>
<div class="codehilite"><pre><span></span>sudo mount -t glusterfs rhgs1:/snaps/snap1/distvol /rhgs/snaps/snap1
</pre></div>


<p>Check the contents of the <strong>read-only</strong> snapshot</p>
<div class="codehilite"><pre><span></span>ls /rhgs/snaps/snap1/mydir <span class="p">|</span> wc -l 
</pre></div>


<p><code>100</code></p>
<p>Now delete all the files in <code>/rhgs/client/nfs/distvol/mydir/</code></p>
<div class="codehilite"><pre><span></span>rm -rf /rhgs/client/nfs/distvol/mydir/*
ls /rhgs/client/nfs/distvol/mydir/ <span class="p">|</span> wc -l
</pre></div>


<p><code>0</code></p>
<p>There are no files left, all 100 files have been deleted. </p>
<p>Check if the files are still available in the snapshot <strong>snap1</strong></p>
<div class="codehilite"><pre><span></span>ls /rhgs/snaps/snap1/mydir/ <span class="p">|</span> wc -l
</pre></div>


<p>``100```</p>
<p>Go back to <strong>rhgs1</strong> and restore the original volume from the snapshot. <br />
For this step the volume must be stopped</p>
<div class="codehilite"><pre><span></span>sudo gluster volume stop distvol 
</pre></div>


<p><code>Stopping volume will make its data inaccessible. Do you want to continue (y/n) y
volume stop: distvol: success</code></p>
<p>Now restore the volume from the snapshot <code>snap1</code></p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot restore snap1
Restore operation will replace the original volume with the snapshotted volume.
Do you still want to <span class="k">continue</span>? <span class="o">(</span>y/n<span class="o">)</span> y
</pre></div>


<p><code>Snapshot restore: snap1: Snap restored successfully</code></p>
<p>Trigger a self-heal:</p>
<div class="codehilite"><pre><span></span>sudo gluster volume heal distvol full
</pre></div>


<p>Once the snapshot is restored it will be deleted. </p>
<p>Go back to <strong>client1</strong> and check the contents of <code>/rhgs/client/nfs/distvol/mydir/</code></p>
<div class="codehilite"><pre><span></span>ls /rhgs/client/nfs/distvol/mydir/ <span class="p">|</span> wc -l
</pre></div>


<p><code>100</code></p>
<p>All the files that have been deleted have been restored from the snapshot that was taken before the deletion.</p>
<h2 id="configure-snapshot-behaviour">CONFIGURE SNAPSHOT BEHAVIOUR</h2>
<p>Since snapshots can easily fill up the available space on the gluster nodes, there are a few tunable parameters to prevent that from happening:</p>
<ul>
<li><strong>snap-max-hard-limit</strong>: Once the snapshot count reaches this limit, no further snapshots can be created. The range is from 1 up to 256.</li>
<li><strong>snap-max-soft-limit</strong>: This parameter is a percentage value and defaults to 90%.  It works together with the auto-delete feature. So once this soft-limit is reached, the system wil delete the oldest snapshot. If auto-delete is disabled, it will display a warning. </li>
<li><strong>auto-delete</strong>: If enabled, this option will work with snap-max-soft-limit as described above. <strong>Note:</strong> This is a global option and can not be set on a per-volume basis.</li>
</ul>
<p>Display the configuration values:</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot config distvol
</pre></div>


<p><code>Snapshot System Configuration:
snap-max-hard-limit : 256
snap-max-soft-limit : 90%
auto-delete : disable
activate-on-create : disable</code><br />
<code>Snapshot Volume Configuration:</code><br />
<code>Volume : distvol
snap-max-hard-limit : 256
Effective snap-max-hard-limit : 256
Effective snap-max-soft-limit : 230 (90%)</code></p>
<p>Set the maximum number of snapshots for <code>distvol</code> to 3</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot config distvol snap-max-hard-limit <span class="m">3</span>
</pre></div>


<p><code>Changing snapshot-max-hard-limit will limit the creation of new snapshots if they exceed the new limit.
Do you want to continue? (y/n) y
snapshot config: snap-max-hard-limit for distvol set successfully</code></p>
<p>Now create 3 snapshots for distvol:</p>
<div class="codehilite"><pre><span></span><span class="k">for</span> i in <span class="o">{</span><span class="m">1</span>..4<span class="o">}</span><span class="p">;</span> <span class="k">do</span> sudo gluster snapshot create snap<span class="nv">$i</span> distvol no-timestamp force<span class="p">;</span> <span class="k">done</span>
</pre></div>


<p><code>snapshot create: success: Snap snap1 created successfully
snapshot create: success: Snap snap2 created successfully
snapshot create: success: Snap snap3 created successfully
snapshot create: success: Snap snap4 created successfully
Warning: Soft-limit of volume (distvol) is reached. Snapshot creation is not possible once hard-limit is reached.</code></p>
<p>If we create a 5th snapshot, we cross the pre-defined limit:</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot create snap5 distvol no-timestamp force
</pre></div>


<p><code>snapshot create: failed: The number of existing snaps has reached the effective maximum limit of 4, for the volume (distvol). Please delete few snapshots before taking further snapshots. 
Snapshot command failed</code></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
                <center>Copyright ©2018 Red Hat, Inc.</center>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>