



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.3">
    
    
      
        <title>Module 5 - Snapshot Operations and Administration - RHGS Test Drive Instructions</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.9b572555.css">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#lab-guide-gluster-test-drive-module-5-snapshot-operations-and-administration" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="RHGS Test Drive Instructions" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                RHGS Test Drive Instructions
              </span>
              <span class="md-header-nav__topic">
                Module 5 - Snapshot Operations and Administration
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    RHGS Test Drive Instructions
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Modules
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Modules
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../gluster-module-1/" title="Module 1 - Introduction to Gluster concepts" class="md-nav__link">
      Module 1 - Introduction to Gluster concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gluster-module-2/" title="Module 2 - Volume Setup and Client Access" class="md-nav__link">
      Module 2 - Volume Setup and Client Access
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gluster-module-3/" title="Module 3 - Volume Operations and Administration" class="md-nav__link">
      Module 3 - Volume Operations and Administration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gluster-module-4/" title="Module 4 - Disperse Volumes (Erasure Coding)" class="md-nav__link">
      Module 4 - Disperse Volumes (Erasure Coding)
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Module 5 - Snapshot Operations and Administration
      </label>
    
    <a href="./" title="Module 5 - Snapshot Operations and Administration" class="md-nav__link md-nav__link--active">
      Module 5 - Snapshot Operations and Administration
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lab-agenda" title="LAB AGENDA" class="md-nav__link">
    LAB AGENDA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#about-snapshots" title="ABOUT SNAPSHOTS" class="md-nav__link">
    ABOUT SNAPSHOTS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" title="GETTING STARTED" class="md-nav__link">
    GETTING STARTED
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-setup" title="LAB SETUP" class="md-nav__link">
    LAB SETUP
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-to-the-lab" title="CONNECT TO THE LAB" class="md-nav__link">
    CONNECT TO THE LAB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-create-the-distvol-volume" title="OPTIONAL: CREATE THE DISTVOL VOLUME" class="md-nav__link">
    OPTIONAL: CREATE THE DISTVOL VOLUME
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snapshot-prerequisites" title="SNAPSHOT PREREQUISITES" class="md-nav__link">
    SNAPSHOT PREREQUISITES
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nfs-client-access" title="NFS CLIENT ACCESS" class="md-nav__link">
    NFS CLIENT ACCESS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creation-of-snapshots" title="CREATION OF SNAPSHOTS" class="md-nav__link">
    CREATION OF SNAPSHOTS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#retrieve-information-about-snapshots" title="RETRIEVE INFORMATION ABOUT SNAPSHOTS" class="md-nav__link">
    RETRIEVE INFORMATION ABOUT SNAPSHOTS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-and-restore-snapshots" title="ACCESS AND RESTORE SNAPSHOTS" class="md-nav__link">
    ACCESS AND RESTORE SNAPSHOTS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-snapshot-behaviour" title="CONFIGURE SNAPSHOT BEHAVIOUR" class="md-nav__link">
    CONFIGURE SNAPSHOT BEHAVIOUR
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gluster-module-6/" title="Module 6 - Geo-Replication and Disaster Recovery" class="md-nav__link">
      Module 6 - Geo-Replication and Disaster Recovery
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gluster-module-7/" title="Module 7 - Brick Replacement" class="md-nav__link">
      Module 7 - Brick Replacement
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lab-agenda" title="LAB AGENDA" class="md-nav__link">
    LAB AGENDA
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#about-snapshots" title="ABOUT SNAPSHOTS" class="md-nav__link">
    ABOUT SNAPSHOTS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" title="GETTING STARTED" class="md-nav__link">
    GETTING STARTED
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-setup" title="LAB SETUP" class="md-nav__link">
    LAB SETUP
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-to-the-lab" title="CONNECT TO THE LAB" class="md-nav__link">
    CONNECT TO THE LAB
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-create-the-distvol-volume" title="OPTIONAL: CREATE THE DISTVOL VOLUME" class="md-nav__link">
    OPTIONAL: CREATE THE DISTVOL VOLUME
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snapshot-prerequisites" title="SNAPSHOT PREREQUISITES" class="md-nav__link">
    SNAPSHOT PREREQUISITES
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nfs-client-access" title="NFS CLIENT ACCESS" class="md-nav__link">
    NFS CLIENT ACCESS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creation-of-snapshots" title="CREATION OF SNAPSHOTS" class="md-nav__link">
    CREATION OF SNAPSHOTS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#retrieve-information-about-snapshots" title="RETRIEVE INFORMATION ABOUT SNAPSHOTS" class="md-nav__link">
    RETRIEVE INFORMATION ABOUT SNAPSHOTS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-and-restore-snapshots" title="ACCESS AND RESTORE SNAPSHOTS" class="md-nav__link">
    ACCESS AND RESTORE SNAPSHOTS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-snapshot-behaviour" title="CONFIGURE SNAPSHOT BEHAVIOUR" class="md-nav__link">
    CONFIGURE SNAPSHOT BEHAVIOUR
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="lab-guide-gluster-test-drive-module-5-snapshot-operations-and-administration">Lab Guide <br/> Gluster Test Drive Module 5 <br/> Snapshot Operations and Administration</h1>
<h2 id="lab-agenda">LAB AGENDA</h2>
<p>Welcome to the Gluster Test Drive Module 5 - Snapshots</p>
<ul>
<li>Learn how snapshots are created and deleted</li>
<li>List available snapshot and get information about them</li>
<li>Access and restore snapshots</li>
<li>Configure snapshot behaviour</li>
</ul>
<h2 id="about-snapshots">ABOUT SNAPSHOTS</h2>
<p>Snapshots are <strong>point-in-time copies</strong> of volumes, which can be used to protect data. They are read-only by default so data on them can&rsquo;t be accidentally deleted, corrupted or modified. </p>
<p>The most important features of snapshots are:</p>
<ul>
<li>Crash consistency</li>
<li>Online snapshots</li>
<li>Quorum based</li>
</ul>
<p>Each snapshot creates as many bricks as the original volume has.</p>
<h2 id="getting-started">GETTING STARTED</h2>
<p>If you have not already done so, click the <img src="http://us-west-2-aws-training.s3.amazonaws.com/awsu-spl/spl02-working-ebs/media/image005.png"> button in the navigation bar above to launch your lab. If you are prompted for a token, use the one distributed to you (or credits you&rsquo;ve purchased).</p>
<blockquote>
<p><strong>NOTE</strong> It may take <strong>up to 10 minutes</strong> for your lab systems to start up before you can access them.</p>
</blockquote>
<h2 id="lab-setup">LAB SETUP</h2>
<h3 id="connect-to-the-lab">CONNECT TO THE LAB</h3>
<p>connect to the <strong>rhgs1</strong> server instance, using its public IP address from the<br />
<strong>Addl. Info</strong> tab to the right. </p>
<div class="codehilite"><pre><span></span>ssh student@&lt;rhgs1PublicIP&gt;
</pre></div>


<h2 id="optional-create-the-distvol-volume">OPTIONAL: CREATE THE DISTVOL VOLUME</h2>
<p>If you have not already done so as part of <strong>Module 2</strong>, deploy the <code>distvol</code> volume, using the provided gdeploy configuration file.</p>
<div class="codehilite"><pre><span></span>gdeploy -c ~/materials/gdeploy/distvol.conf
</pre></div>


<p>Confirm the volume configuration.</p>
<div class="codehilite"><pre><span></span>sudo gluster volume info distvol
<span class="sb">``</span>
Volume Name: distvol
Type: Distribute
Volume ID: 957b4f60-4c2e-401f-b13c-558fd9df0c45
Status: Started
Snapshot Count: <span class="m">0</span>
Number of Bricks: <span class="m">6</span>
Transport-type: tcp
Bricks:
Brick1: rhgs1:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick1/distvol
Brick2: rhgs2:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick2/distvol
Brick3: rhgs3:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick3/distvol
Brick4: rhgs4:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick4/distvol
Brick5: rhgs5:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick5/distvol
Brick6: rhgs6:/run/gluster/snaps/d1fbe5166ad54fb7b0917e8cf5d5ba00/brick6/distvol
Options Reconfigured:
transport.address-family: inet
nfs.disable: off
features.quota: off
features.inode-quota: off
features.quota-deem-statfs: off
</pre></div>


<p>Make sure the <code>nfs.disable</code> attribute is set to off. In case it&rsquo;s not, run</p>
<div class="codehilite"><pre><span></span>sudo gluster volume <span class="nb">set</span> distvol nfs.disable off
</pre></div>


<h2 id="snapshot-prerequisites">SNAPSHOT PREREQUISITES</h2>
<p>The snapshots will consists of the same number of bricks as the original<br />
volumes. By default bricks communicate via privileged ports, but the number of<br />
such ports is limited to 1024. In order to support up to 256 snapshots per<br />
volume the glusterd must be allowed to use non-privileged ports:</p>
<p>Permit insecure ports for the volume for which snapshots will be used:</p>
<div class="codehilite"><pre><span></span><span class="c1"># sudo gluster volume set distvol server.allow-insecure on</span>
</pre></div>


<p>Edit <code>/etc/glusterfs/glusterd.vol</code> in every cluster node, and add the<br />
following line:</p>
<div class="codehilite"><pre><span></span>option rpc-auth-allow-insecure on
</pre></div>


<p>Then restart the glusterd service to make make the changes effective:</p>
<div class="codehilite"><pre><span></span><span class="c1"># sudo systemctl restart glusterd</span>
</pre></div>


<h2 id="nfs-client-access">NFS CLIENT ACCESS</h2>
<p>A Gluster volume can be accessed through multiple standard client protocols, as well as through specialized methods including the OpenStack Swift protocol and a direct API.  </p>
<p>For many common use cases, the well-established NFS protocol is used for ease of implementation and compatibility with existing applications and architectures. For some use cases, the NFS protocol may also offer a performance benefit over other access methods. </p>
<p>You can connect to the <strong>client1</strong> system via <code>ssh</code> directly from the rhgs1 system.    </p>
<div class="codehilite"><pre><span></span>ssh student@client1                                                                    
</pre></div>


<p>Here, on the RHEL client, you will mount via NFS the Gluster <strong>distvol</strong> volume you created above.                                                                            </p>
<div class="codehilite"><pre><span></span>sudo mkdir -p /rhgs/client/nfs/distvol 
sudo mount -t nfs rhgs1:/distvol /rhgs/client/nfs/distvol 
</pre></div>


<p>Check the mount and observe the output.                                                </p>
<div class="codehilite"><pre><span></span>df -h /rhgs/client/nfs/distvol 
</pre></div>


<p><code>Filesystem      Size  Used Avail Use% Mounted on</code>                                 <br />
<code>rhgs1:/distvol   60G  198M   60G   1% /rhgs/client/nfs/distvol</code>                     </p>
<div class="codehilite"><pre><span></span>mount <span class="p">|</span> grep distvol                                                                   
</pre></div>


<p><code>rhgs1:/distvol on /rhgs/client/nfs/distvol type nfs (rw,relatime,vers=3,rsize=1048576,wsize=1048576,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=10.100.1.11,mountvers=3,mountport=38465,mountproto=tcp,local_lock=none,addr=10.100.1.11)</code>     </p>
<p>Create and set permissions on a subdirectory to hold your data.                        </p>
<div class="codehilite"><pre><span></span>sudo mkdir /rhgs/client/nfs/distvol/mydir                                              
sudo chmod <span class="m">777</span> /rhgs/client/nfs/distvol/mydir                                          
</pre></div>


<p>Add 100 files to the directory.                                                        </p>
<div class="codehilite"><pre><span></span><span class="k">for</span> i in <span class="o">{</span><span class="m">001</span>..100<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> hello<span class="nv">$i</span> &gt; /rhgs/client/nfs/distvol/mydir/file<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>     
</pre></div>


<p>List the directory, counting its contents to confirm the 100 files written.                                                                                                  </p>
<div class="codehilite"><pre><span></span>ls /rhgs/client/nfs/distvol/mydir/ <span class="p">|</span> wc -l 
</pre></div>


<p><code>100</code>                                                                                                                                                                      </p>
<h2 id="creation-of-snapshots">CREATION OF SNAPSHOTS</h2>
<p>Now that the volume is populated with your 100 data files take a snapshot.<br />
Logout from <strong>client1</strong></p>
<div class="codehilite"><pre><span></span>exit
</pre></div>


<p>Create the snapshot on <strong>rhgs1</strong></p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot create snap1 distvol no-timestamp description <span class="s2">&quot;populated volume&quot;</span>
</pre></div>


<p><code>snapshot create: success: Snap snap1 created successfully</code></p>
<h2 id="retrieve-information-about-snapshots">RETRIEVE INFORMATION ABOUT SNAPSHOTS</h2>
<p>Check the list of available snapshots</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot list
</pre></div>


<p><code>snap1</code></p>
<p>There is more information available for this snapshot</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot info volume distvol
</pre></div>


<div class="codehilite"><pre><span></span>Volume Name               : distvol        
Snaps Taken               : 1              
Snaps Available           : 255            
        Snapshot                  : snap1                      
        Snap UUID                 : bc9abd1b-6239-49ec-aa0c-d0e56d619dd1               
        Description               : populated volume                                   
        Created                   : 2018-01-30 10:47:28                                
        Status                    : Stopped    
</pre></div>


<h2 id="access-and-restore-snapshots">ACCESS AND RESTORE SNAPSHOTS</h2>
<p>Snaphosts of volumes can only be accessed via FUSE (native) mounts. <br />
In order to do that snapshots must be activated.</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot activate snap1
</pre></div>


<p><code>Snapshot activate: snap1: Snap activated successfully</code></p>
<p>Connect to <strong>client1</strong> using ssh and create a directory for the snapshots to be mounted:</p>
<div class="codehilite"><pre><span></span>sudo mkdir -p /rhgs/snaps/snap1
</pre></div>


<p>Mount the snapshot using</p>
<div class="codehilite"><pre><span></span>sudo mount -t glusterfs rhgs1:/snaps/snap1/distvol /rhgs/snaps/snap1
</pre></div>


<p>Check the contents of the <strong>read-only</strong> snapshot</p>
<div class="codehilite"><pre><span></span>ls /rhgs/snaps/snap1/mydir <span class="p">|</span> wc -l 
</pre></div>


<p><code>100</code></p>
<p>Now delete all the files in <code>/rhgs/client/nfs/distvol/mydir/</code></p>
<div class="codehilite"><pre><span></span>rm -rf /rhgs/client/nfs/distvol/mydir/*
ls /rhgs/client/nfs/distvol/mydir/ <span class="p">|</span> wc -l
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">ls</span><span class="o">:</span> <span class="n">cannot</span> <span class="n">access</span> <span class="sr">/rhgs/client/nfs/distvol/mydir/</span><span class="o">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span>
<span class="mi">0</span>
</pre></div>


<p>There are no files left, all 100 files have been deleted. </p>
<p>Check if the files are still available in the snapshot <strong>snap1</strong></p>
<div class="codehilite"><pre><span></span>ls /rhgs/snaps/snap1/mydir/ <span class="p">|</span> wc -l
</pre></div>


<p><code>100</code></p>
<p>Go back to <strong>rhgs1</strong> and restore the original volume from the snapshot. <br />
For this step the volume must be stopped</p>
<div class="codehilite"><pre><span></span>sudo gluster volume stop distvol 
</pre></div>


<div class="codehilite"><pre><span></span>Stopping volume will make its data inaccessible. Do you want to continue (y/n) y
volume stop: distvol: success
</pre></div>


<p>Now restore the volume from the snapshot <code>snap1</code></p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot restore snap1
Restore operation will replace the original volume with the snapshotted volume.
Do you still want to <span class="k">continue</span>? <span class="o">(</span>y/n<span class="o">)</span> y
</pre></div>


<p><code>Snapshot restore: snap1: Snap restored successfully</code></p>
<p>Start the volume: </p>
<div class="codehilite"><pre><span></span>sudo gluster volume start distvol
</pre></div>


<p>Go back to <strong>client1</strong> and check the contents of <code>/rhgs/client/nfs/distvol/mydir/</code></p>
<div class="codehilite"><pre><span></span>ls /rhgs/client/nfs/distvol/mydir/ <span class="p">|</span> wc -l
</pre></div>


<p><code>100</code></p>
<p>All the files that have been deleted have been restored from the snapshot that was taken before the deletion.</p>
<p>IMPORTANT: Once the snapshot is restored it will be deleted. If you plan on further possible restores, create a new snapshot immediately.</p>
<h2 id="configure-snapshot-behaviour">CONFIGURE SNAPSHOT BEHAVIOUR</h2>
<p>Since snapshots can easily fill up the available space on the gluster nodes, there are a few tunable parameters to prevent that from happening:</p>
<ul>
<li><strong>snap-max-hard-limit</strong>: Once the snapshot count reaches this limit, no further snapshots can be created. The range is from 1 up to 256.</li>
<li><strong>snap-max-soft-limit</strong>: This parameter is a percentage value and defaults to 90%.  It works together with the auto-delete feature. So once this soft-limit is reached, the system wil delete the oldest snapshot. If auto-delete is disabled, it will display a warning. </li>
<li><strong>auto-delete</strong>: If enabled, this option will work with snap-max-soft-limit as described above. <strong>Note:</strong> This is a global option and can not be set on a per-volume basis.</li>
</ul>
<p>Log out from <strong>client1</strong></p>
<div class="codehilite"><pre><span></span><span class="nb">exit</span>
</pre></div>


<p>Display the configuration values:</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot config distvol
</pre></div>


<div class="codehilite"><pre><span></span>Snapshot System Configuration:
snap-max-hard-limit : 256
snap-max-soft-limit : 90%
auto-delete : disable
activate-on-create : disable

Snapshot Volume Configuration:

Volume : distvol
snap-max-hard-limit : 256
Effective snap-max-hard-limit : 256
Effective snap-max-soft-limit : 230 (90%)
</pre></div>


<p>Set the maximum number of snapshots for <code>distvol</code> to 3</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot config distvol snap-max-hard-limit <span class="m">3</span>
</pre></div>


<div class="codehilite"><pre><span></span>Changing snapshot-max-hard-limit will limit the creation of new snapshots if they exceed the new limit.
Do you want to continue? (y/n) y
snapshot config: snap-max-hard-limit for distvol set successfully
</pre></div>


<p>Now create 3 snapshots for distvol:</p>
<div class="codehilite"><pre><span></span><span class="k">for</span> i in <span class="o">{</span><span class="m">1</span>..4<span class="o">}</span><span class="p">;</span> <span class="k">do</span> sudo gluster snapshot create snap<span class="nv">$i</span> distvol no-timestamp force<span class="p">;</span> <span class="k">done</span>
</pre></div>


<div class="codehilite"><pre><span></span>snapshot create: success: Snap snap1 created successfully
snapshot create: success: Snap snap2 created successfully
snapshot create: success: Snap snap3 created successfully
snapshot create: success: Snap snap4 created successfully
Warning: Soft-limit of volume (distvol) is reached. Snapshot creation is not possible once hard-limit is reached.
</pre></div>


<p>If we create a 5th snapshot, we cross the pre-defined limit:</p>
<div class="codehilite"><pre><span></span>sudo gluster snapshot create snap5 distvol no-timestamp force
</pre></div>


<div class="codehilite"><pre><span></span>snapshot create: failed: The number of existing snaps has reached the effective maximum limit of 4, for the volume (distvol). Please delete few snapshots before taking further snapshots. 
Snapshot command failed
</pre></div>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../gluster-module-4/" title="Module 4 - Disperse Volumes (Erasure Coding)" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 4 - Disperse Volumes (Erasure Coding)
              </span>
            </div>
          </a>
        
        
          <a href="../gluster-module-6/" title="Module 6 - Geo-Replication and Disaster Recovery" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 6 - Geo-Replication and Disaster Recovery
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright ©2018 Red Hat, Inc.
          </div>
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.abd7b172.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>